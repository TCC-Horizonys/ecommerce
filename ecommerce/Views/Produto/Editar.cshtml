@model ecommerce.Models.Produto

<div class="row">
    <div class="col-md-8 mx-auto rounded border p-3">
        <h2 class="text-center mb-5">Editar Produto</h2>


        <form asp-action="Editar" method="post" enctype="multipart/form-data">
            <input type="hidden" asp-for="Id" />

            <div class="row mb-3">
                <label class="col-sm-4 col-form-label">Id</label>
                <div class="col-sm-8">
                    <input class="form-control-plaintext" readonly value="@Model.Id">
                </div>
            </div>

            <div class="row mb-3">
                <label for="Nome" class="col-sm-4 col-form-label">Nome</label>
                <div class="col-sm-8">
                    <input id="Nome" class="form-control" asp-for="Nome">
                    <span asp-validation-for="Nome" class="text-danger"></span>
                </div>
            </div>

            <div class="row mb-3">
                <label for="Categoria" class="col-sm-4 col-form-label">Categoria</label>
                <div class="col-sm-8">
                    <select id="Categoria" name="Categoria" class="form-select" asp-for="Categoria">
                        <option value='Roupa'>Roupa</option>
                        <option value='Arte'>Arte</option>
                        <option value='Movel'>Móvel</option>
                        <option value='Joia'>Jóias</option>
                    </select>
                </div>
            </div>

            <div class="row mb-3">
                <label for="Preco" class="col-sm-4 col-form-label">Preço (R$)</label>
                <div class="col-sm-8">
                    <input id="Preco" name="Preco" asp-for="Preco" class="form-control" type="text" placeholder="0,00" />
                    <span asp-validation-for="Preco" class="text-danger"></span>
                </div>
            </div>

            <div class="row mb-3">
                <label for="Descricao" class="col-sm-4 col-form-label">Estado de Conservação</label>
                <div class="col-sm-8">
                    <textarea id="Descricao" name="Descricao" class="form-control" asp-for="EstadoConservacao"></textarea>
                    <span asp-validation-for="EstadoConservacao" class="text-danger"></span>
                </div>
            </div>

            <div class="row mb-3">
            @foreach (var img in Model.Imagens.OrderBy(i => i.OrdemImagem))
            {
                    <div class="card" data-imagem-id="@img.ImagemId" style="width: 10rem;">
                        <img src="@Url.Content("~/img/" + img.Url)" class="card-img-top" alt="Imagem do produto">
                        <div class="card-body text-center">
                            <button type="button" class="btn btn-sm btn-danger mt-1" onclick="removerImagem(@img.ImagemId)">
                                Remover
                            </button>
                        </div>
                    </div>
                }
            </div>

            <div class="row mb-3">
                <label for="imagemArquivo" class="col-sm-4 col-form-label">Imagem</label>
                <div class="col-sm-8">
                    <input id="imagensArquivo" type="file" class="form-control" name="imagensArquivo" multiple accept="image/*">
                    <span asp-validation-for="Imagens" class="text-danger"></span>
                </div>
            </div>


            <div class="row mb-3">
                <label for="DataCriada" class="col-sm-4 col-form-label">Data Criação</label>
                <div class="col-sm-8">
                    <input id="DataCriada" class="form-control-plaintext" readonly value="@Model.DataCriada.ToString("dd/MM/yyyy")">
                </div>
            </div>

            <div class="row">
                <div class="offset-sm-4 col-sm-4 d-grid">
                    <button type="submit" class="btn btn-primary">Submit</button>
                </div>
                <div class="col-sm-4 d-grid">
                    <a class="btn btn-outline-primary" asp-controller="Produto" asp-action="Index" role="button">
                        Cancel
                    </a>
                </div>
            </div>
        </form>
    </div>
</div>


@section Scripts {
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const precoInput = document.getElementById("Preco");

            // Valor inicial formatado
            if (!precoInput.value) {
                precoInput.value = "0,00";
            }

            precoInput.addEventListener("input", function (e) {
                let value = e.target.value;

                // Remove tudo que não for número
                value = value.replace(/\D/g, "");

                // Se vazio, assume 0
                if (value === "") {
                    value = "0";
                }

                // Converte para centavos e insere a vírgula
                value = (parseInt(value) / 100).toFixed(2);

                // Substitui ponto por vírgula
                value = value.replace(".", ",");

                e.target.value = value;
            });

            // Garante o formato correto ao perder o foco
            precoInput.addEventListener("blur", function (e) {
                if (e.target.value === "" || e.target.value === "0") {
                    e.target.value = "0,00";
                }
            });
        });

                function removerImagem(imagemId) {
            if (!confirm("Deseja realmente remover esta imagem?")) return;

            const formData = new FormData();
            formData.append("id", imagemId); // parâmetro enviado ao controller

            fetch('@Url.Action("RemoverImagem", "Produto")', {
                method: 'POST',
                body: formData
            })
            .then(res => res.json())
            .then(data => {
                if (data.sucesso) {
                    const imgCard = document.querySelector(`[data-imagem-id='${imagemId}']`);
                    if (imgCard) imgCard.remove(); // remove só o card da imagem
                } else {
                    alert(data.mensagem || "Erro ao remover imagem.");
                }
            })
            .catch(err => {
                console.error(err);
                alert("Erro de comunicação com o servidor.");
            });
        }
    </script>
}